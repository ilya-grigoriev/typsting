#!/bin/bash
set -eu

GREEN='\e[32m'
RED='\e[31m'
GREY='\033[38;5;250m'
RESET='\e[0m'

WIDTH=10
HEIGHT=1.5

IFS='\n'
FILEPATH="formulas.typ"
TEMP_FILE=$(mktemp)

clear_() {
	if [[ -e "$TEMP_FILE" ]]; then
		rm "$TEMP_FILE"
		rm "${TEMP_FILE}.png"
	fi
	is_correct=-1
	formula=""
	image=""
}

clear_and_exit() {
	clear_
	clear
	exit
}

print_image() {
	echo "#set page(width: ${WIDTH}cm, height: ${HEIGHT}cm)" > "$TEMP_FILE"
	echo "$line" >> "$TEMP_FILE"

	if [[ ! -e "${TEMP_FILE}.png" ]]; then
		typst compile "$TEMP_FILE" -f png "${TEMP_FILE}.png"
	fi
	chafa --align center "${TEMP_FILE}.png"
}

get_typed_formula() {
	if [[ $is_correct == 1 ]]; then
		echo -e "${GREEN}correct${RESET}"
	elif [[ $is_correct == 0 ]]; then
		echo -e "${RED}incorrect${RESET}"
	fi
	read -e -p "> " -i "$formula" formula
}

trim_formula() {
	trimmed_line=${line#$}
	trimmed_line=${trimmed_line%$}
	trimmed_line=${trimmed_line# }
	trimmed_line=${trimmed_line% }
}

check_typed_formula() {
	trim_formula
	if [[ "$(echo $formula | tr -s ' ')" == "$trimmed_line" ]]; then
		is_correct=1
	else
		is_correct=0
		fails=$((fails-1))
	fi
}

print_header() {
	clear
	echo
	echo -e " ${GREY}Fails: $fails$RESET"
	echo
}

check_filepath() {
	if [[ ! -e $FILEPATH ]]; then
		echo "filepath doesn't exist"
		exit 1
	fi
}

suggest_next_task() {
	read -p "next task? [Y/n]: " choice < /dev/tty
}

main() {
	check_filepath

	result=""
	formula=""
	is_correct=-1
	while true; do
		line=$(shuf -n 1 "$FILEPATH")
		fails=5
		while [[ $fails != 0 ]]; do
			print_header
			print_image
			get_typed_formula
			check_typed_formula

			if [[ $is_correct == 1 ]]; then
				suggest_next_task
				if [[ "$choice" == "y" || "$choice" == "Y" || "$choice" == "" ]]; then
					clear_;
					break;
				else
					clear_and_exit
				fi
			fi
		done

	done

	clear_and_exit
}

trap clear_and_exit SIGINT
trap clear_and_exit SIGTERM
trap clear_and_exit SIGKILL
trap clear_and_exit SIGQUIT
trap clear_and_exit EXIT

main
